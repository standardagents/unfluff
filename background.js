const W=new Map,A="https://unfluff.standardagents.ai";let r=null,m=!1,y=null,g=null,h=0;const S=new Set,E=6e4,R=30,u=[];function B(n){const e=Date.now();for(;u.length>0&&u[0]<e-E;)u.shift();if(u.length+n>R)return!1;for(let t=0;t<n;t++)u.push(e);return!0}const f=new Map,p=new Map;async function k(){const n=await chrome.storage.local.get("installId");if(n.installId)return n.installId;const e=crypto.randomUUID();return await chrome.storage.local.set({installId:e}),e}async function _(){return(await chrome.storage.local.get("apiUrl")).apiUrl||A}async function w(){if(r&&r.readyState===WebSocket.OPEN||r&&r.readyState===WebSocket.CONNECTING)return;const n=await k(),e=await _(),t=e.startsWith("https")?"wss":"ws",c=`${e.replace(/^https?/,t)}/api/unfluff/ws?installId=${encodeURIComponent(n)}`;console.log(`[Unfluff SW] Connecting WebSocket to ${c}`);try{r=new WebSocket(c)}catch(s){console.error("[Unfluff SW] WebSocket constructor failed:",s),T();return}r.onopen=()=>{console.log("[Unfluff SW] WebSocket connected"),m=!0,h=0,L()},r.onmessage=s=>{if(typeof s.data=="string"&&s.data!=="pong")try{const a=JSON.parse(s.data);C(a)}catch(a){console.error("[Unfluff SW] Failed to parse WS message:",a)}},r.onclose=()=>{console.log("[Unfluff SW] WebSocket closed"),m=!1,r=null,$(),T()},r.onerror=s=>{console.error("[Unfluff SW] WebSocket error:",s)}}function T(){if(y)return;const n=Math.min(1e3*Math.pow(2,h),3e4);h++,console.log(`[Unfluff SW] Reconnecting in ${n}ms (attempt ${h})`),y=setTimeout(()=>{y=null,w()},n)}function L(){$(),g=setInterval(()=>{r&&r.readyState===WebSocket.OPEN&&r.send("ping")},25e3)}function $(){g&&(clearInterval(g),g=null)}function C(n){if(n.type==="RESULT"){const e=n.result,t=p.get(e.id);if(!t){W.set(e.id,e);return}const o=f.get(t);if(!o)return;W.set(e.id,e),o.results.push(e),o.postIds.delete(e.id),p.delete(e.id),S.delete(e.id),o.postIds.size===0&&I(t)}else if(n.type==="BATCH_DONE")for(const[e,t]of f)t.postIds.size===0&&I(e);else if(n.type==="BATCH_ERROR"){console.error("[Unfluff SW] Server batch error:",n.error);for(const[e,t]of f)clearTimeout(t.timeout),t.resolve({type:"BATCH_ERROR",error:n.error||"Server error"}),b(e)}}function I(n){const e=f.get(n);if(!e)return;clearTimeout(e.timeout);const t=[...e.cachedResults,...e.results];console.log(`[Unfluff SW] Batch ${n} complete: ${t.length} results`),e.resolve({type:"BATCH_RESULT",results:t}),b(n)}function b(n){const e=f.get(n);if(e)for(const t of e.postIds)p.delete(t),S.delete(t);f.delete(n)}chrome.runtime.onMessage.addListener((n,e,t)=>n.type!=="ANALYZE_BATCH"?!1:(console.log(`[Unfluff SW] Received batch of ${n.posts.length} posts`),O(n).then(o=>{console.log(`[Unfluff SW] Sending response: ${o.type}`,o.type==="BATCH_RESULT"?`${o.results.length} results`:""),t(o)}).catch(o=>{console.error("[Unfluff SW] Error:",o),t({type:"BATCH_ERROR",error:o instanceof Error?o.message:"Unknown error"})}),!0));async function O(n){const{posts:e}=n,t=[],c=e.filter(l=>{const i=W.get(l.id);return i?(t.push(i),!1):!0}).filter(l=>!S.has(l.id));if(c.length===0)return console.log("[Unfluff SW] All posts cached or in-flight"),{type:"BATCH_RESULT",results:t};if(!B(c.length))return console.warn(`[Unfluff SW] Rate limited — ${c.length} posts rejected (${u.length}/${R} in window)`),{type:"BATCH_ERROR",error:"Rate limited — please wait a moment"};for(const l of c)S.add(l.id);const s=await H(c);if(await w(),await P(5e3),!r||r.readyState!==WebSocket.OPEN)throw new Error("WebSocket not connected");const a=crypto.randomUUID(),d=new Set(s.map(l=>l.id));for(const l of d)p.set(l,a);return new Promise(l=>{const i=setTimeout(()=>{console.error(`[Unfluff SW] Batch ${a} timed out after 60s`),l({type:"BATCH_ERROR",error:"Analysis timed out"}),b(a)},6e4);f.set(a,{postIds:d,results:[],resolve:l,cachedResults:t,timeout:i});const U=JSON.stringify({type:"ANALYZE_BATCH",posts:s});r.send(U),console.log(`[Unfluff SW] Sent batch ${a} (${s.length} posts) via WebSocket`)})}function P(n){return m&&(r==null?void 0:r.readyState)===WebSocket.OPEN?Promise.resolve():new Promise((e,t)=>{const o=Date.now(),c=()=>{m&&(r==null?void 0:r.readyState)===WebSocket.OPEN?e():Date.now()-o>n?t(new Error("WebSocket connection timeout")):setTimeout(c,100)};c()})}const N=new Set(["image/jpeg","image/png","image/gif","image/webp"]);async function H(n){return Promise.all(n.map(async e=>{if(!e.imageUrls||e.imageUrls.length===0)return e;console.log(`[Unfluff SW] Fetching ${e.imageUrls.length} images for post ${e.id}`);const t=[];for(const s of e.imageUrls)try{const a=await fetch(s);if(!a.ok){console.warn(`[Unfluff SW] Image fetch failed: ${a.status} ${a.statusText} for ${s.slice(0,100)}`);continue}const d=await a.blob(),l=d.type||"image/jpeg";if(!N.has(l)){console.warn(`[Unfluff SW] Skipping non-raster type ${l} from ${s.slice(0,80)}`);continue}const i=await d.arrayBuffer(),U=M(i);console.log(`[Unfluff SW] Image fetched OK: ${(i.byteLength/1024).toFixed(0)}KB ${l} from ${s.slice(0,80)}`),t.push({base64:U,mimeType:l})}catch(a){console.error(`[Unfluff SW] Image fetch error for ${s.slice(0,100)}:`,a)}t.length>0?console.log(`[Unfluff SW] Post ${e.id}: ${t.length}/${e.imageUrls.length} images fetched successfully`):e.imageUrls.length>0&&console.warn(`[Unfluff SW] Post ${e.id}: ALL ${e.imageUrls.length} image fetches failed! URLs: ${e.imageUrls.map(s=>s.slice(0,60)).join(", ")}`);const{imageUrls:o,...c}=e;return{...c,images:t.length>0?t:void 0}}))}function M(n){const e=new Uint8Array(n);let t="";for(let o=0;o<e.length;o++)t+=String.fromCharCode(e[o]);return btoa(t)}chrome.runtime.onInstalled.addListener(()=>{console.log("[Unfluff] Extension installed")});const v=["www.linkedin.com"];chrome.tabs.onUpdated.addListener((n,e,t)=>{if(!(!e.url||!t.url)){try{const o=new URL(t.url).hostname;if(!v.some(c=>o===c||o.endsWith("."+c)))return}catch{return}console.log(`[Unfluff SW] Tab URL changed → ${t.url}, re-injecting content script into all frames`),chrome.scripting.executeScript({target:{tabId:n,allFrames:!0},files:["content.js"]}).catch(o=>{console.log("[Unfluff SW] executeScript error (expected for some frames):",o.message)})}});w();console.log("[Unfluff SW] Service worker started (WebSocket mode)");
